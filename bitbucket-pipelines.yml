
image: atlassian/default-image:3

pipelines:
  tags:
    "v*":   # bv. v1.2.9
      - step:
          name: "Build WP-ready ZIP"
          script:
            - set -e
            - echo "BITBUCKET_TAG=${BITBUCKET_TAG}"
            - echo "BITBUCKET_COMMIT=${BITBUCKET_COMMIT}"
            - pwd
            - ls -la
            # Bouw ZIP met vaste topmap 'db-acf-extension/' vanaf de commit van de tag
            - git archive --format=zip \
                --output "db-acf-extension-${BITBUCKET_TAG}.zip" \
                --prefix=db-acf-extension/ \
                "${BITBUCKET_COMMIT}"
            - ls -lh "db-acf-extension-${BITBUCKET_TAG}.zip"
          artifacts:
            - "db-acf-extension-${BITBUCKET_TAG}.zip"

      - step:
          name: "Upload ZIP naar Bitbucket Downloads"
          script:
            - ls -lh   # sanity check: artifact is gedownload in de workdir
            - pipe: atlassian/bitbucket-upload-file:0.7.5
              variables:
                ATLASSIAN_ACCOUNT_EMAIL: $ATLASSIAN_ACCOUNT_EMAIL
                ATLASSIAN_API_TOKEN: $ATLASSIAN_API_TOKEN
                FILENAME: "db-acf-extension-${BITBUCKET_TAG}.zip"
